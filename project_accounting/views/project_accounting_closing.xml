<odoo>
	<data>
           <record model="ir.ui.view" id="project_accounting.project_accounting_closing_tree">
              <field name="name">Project accounting closing</field>
              <field name="model">project.accounting_closing</field>
              <field name="arch" type="xml">
                <tree create="true">
                  	<field name="project_id" optional="show"/>
                  	<field name="closing_date" optional="show"/>
			<field name="previous_closing" optional="hide"/>
			<!-- Validation -->
			<field name="is_validated" optional="show"/>
			<field name="comment" optional="hide" widget="text"/>
			<field name="comment_previous" optional="hide" widget="text"/>
			<!-- Facturation -->
			<field name="invoice_period_amount" optional="show" sum="Total"/>
			<!-- Achats-->
			<field name="purchase_period_amount" optional="show" sum="Total"/>
			<!-- Total provision -->
			<field name="provision_previous_balance_sum" optional="hide" sum="Total"/>
			<field name="provision_balance_sum" optional="hide" sum="Total"/>
			<!-- PCA -->
			<field name="pca_previous_balance" optional="hide" sum="Total"/>
			<field name="pca_period_amount" optional="show" sum="Total"/>
			<field name="pca_balance" optional="hide" sum="Total"/>
			<!-- FAE -->
			<field name="fae_previous_balance" optional="hide" sum="Total"/>
			<field name="fae_period_amount" optional="show" sum="Total"/>
			<field name="fae_balance" optional="hide" sum="Total"/>
			<!-- CCA -->
			<field name="cca_previous_balance" optional="hide" sum="Total"/>
			<field name="cca_period_amount" optional="show" sum="Total"/>
			<field name="cca_balance" optional="hide" sum="Total"/>
			<!-- FNP -->
			<field name="fnp_previous_balance" optional="hide" sum="Total"/>
			<field name="fnp_period_amount" optional="show" sum="Total"/>
			<field name="fnp_balance" optional="hide" sum="Total"/>
			<!-- Production -->
			<field name="production_previous_balance" optional="hide" sum="Total"/>
			<field name="production_period_amount" optional="show" sum="Total"/>
			<field name="production_stock" optional="show" sum="Total"/>
			<field name="production_destocking" optional="show" sum="Total"/>
			<field name="production_balance" optional="hide" sum="Total"/>
			<!-- Chiffre d'afffaire -->
			<field name="gross_revenue" optional="hide" sum="Total"/>
			<field name="internal_revenue" optional="hide" sum="Total"/>
			<field name="internal_margin_amount" optional="hide" sum="Total"/>
			<field name="internal_margin_rate" widget="progressbar" optional="hide"/>
                </tree>
              </field>
            </record>


           <record model="ir.ui.view" id="project_accounting.project_accounting_closing_form">
              <field name="name">Project accounting closing</field>
              <field name="model">project.accounting_closing</field>
              <field name="arch" type="xml">
                <form>
			<group name="general">
				<group>
					<field name="project_id"/>
					<field name="closing_date"/>
					<field name="previous_closing"/>
				</group>
				<group>
					<field name="is_validated"/>
					<field name="comment" widget="text"/>
					<field name="comment_previous" widget="text"/>
				</group>
			</group>
			<group col="3">
				<group name="invoice" string="Facturation">
					<field name="invoice_period_amount"/>
				</group>
				<group name="purchase" string="Achats">
					<field name="purchase_period_amount"/>
				</group>
				<group name="prov" string="Total provisions">
					<field name="provision_previous_balance_sum"/>
					<field name="provision_balance_sum"/>
				</group>
			</group>
			<group col="4">
				<group name="pca" string="PCA">
					<field name="pca_previous_balance"/>
					<field name="pca_period_amount"/>
					<field name="pca_balance"/>
				</group>
				<group name="fae" string="FAE">
					<field name="fae_previous_balance"/>
					<field name="fae_period_amount"/>
					<field name="fae_balance"/>
				</group>
				<group name="cca" string="CCA">
					<field name="cca_previous_balance"/>
					<field name="cca_period_amount"/>
					<field name="cca_balance"/>
				</group>
				<group name="fnp" string="FNP">
					<field name="fnp_previous_balance"/>
					<field name="fnp_period_amount"/>
					<field name="fnp_balance"/>
				</group>
			</group>
			<group>
				<group name="prod" string="Production">
					<group>
						<field name="production_previous_balance"/>
						<field name="production_period_amount"/>
						<field name="production_stock"/>
					</group>
					<group>
						<field name="production_destocking"/>
						<field name="production_balance"/>
					</group>
				</group>
				<group name="revenue" string="Chiffre d'affaire">
					<group>
						<field name="gross_revenue"/>
						<field name="internal_revenue"/>
					</group>
					<group>
						<field name="internal_margin_amount"/>
						<field name="internal_margin_rate" widget="progressbar"/>
					</group>
				</group>
			</group>
                </form>
              </field>
            </record>

	<record id="project_accounting.project_accounting_closing_pivot" model="ir.ui.view">
		<field name="name">project.accounting_closing.pivot</field>
		<field name="model">project.accounting_closing</field>
		<field name="arch" type="xml">
		    <pivot string="Clôtures comptables" sample="1">
			<field name="closing_date" type="col" interval="year"/>
			<field name="closing_date" type="col" interval="month"/>
			<field name="project_id" type="row"/>
			<field name="invoice_period_amount" type="measure"/>
			<field name="purchase_period_amount" type="measure"/>
			<field name="provision_previous_balance_sum" type="measure"/>
			<field name="provision_balance_sum" type="measure"/>
			<!--
			<field name="pca_previous_balance" type="measure"/>
			-->
			<field name="pca_period_amount" type="measure"/>
			<field name="pca_balance" type="measure"/>
			<!--
			<field name="fae_previous_balance" type="measure"/>
			-->
			<field name="fae_period_amount" type="measure"/>
			<field name="fae_balance" type="measure"/>
			<!--
			<field name="cca_previous_balance" type="measure"/>
			-->
			<field name="cca_period_amount" type="measure"/>
			<field name="cca_balance" type="measure"/>
			<!--
			<field name="fnp_previous_balance" type="measure"/>
			-->
			<field name="fnp_period_amount" type="measure"/>
			<field name="fnp_balance" type="measure"/>
			<!--
			<field name="production_previous_balance" type="measure"/>
			-->
			<field name="production_period_amount" type="measure"/>
			<field name="production_stock" type="measure"/>
			<field name="production_destocking" type="measure"/>
			<field name="production_balance" type="measure"/>
			<field name="gross_revenue" type="measure"/>
			<field name="internal_revenue" type="measure"/>
			<field name="internal_margin_amount" type="measure"/>
			<field name="internal_margin_rate" type="measure"/>
		    </pivot>
		</field>
	</record>

        <record id="view_project_accounting_closing_search" model="ir.ui.view">
            <field name="name">project.accounting_closing</field>
            <field name="model">project.accounting_closing</field>
            <field name="arch" type="xml">
                <search string="Search Project accounting closing">
                    <field name="rel_project_user_id" string="Directeur de mission (nom de famille)"/>
                    <field name="rel_project_partner_id" string="Client" filter_domain="[('rel_project_partner_id', 'child_of', self)]"/>
                    <separator/>
                    <filter string="Date de la clôture comptable" name="closing_date" date="closing_date"/>
                    <filter string="Clôture validée" name="validated" domain="[('is_validated', '=', True)]"/>
                    <filter string="Clôture non validée" name="not_validated" domain="[('is_validated', '=', False)]"/>
                    <separator/>
                    <group expand="0" string="Group By">
                        <filter string="Directeur de mission" name="Manager" context="{'group_by': 'rel_project_user_id'}"/>
                        <filter string="Client" name="Partner" context="{'group_by': 'rel_project_partner_id'}"/>
                        <filter string="Etat de validation" name="groupby_is_validated" context="{'group_by': 'is_validated'}" />
                    </group>
		    <!--
		    -->
                </search>
            </field>
        </record>

        <record id="project_accounting_closing_action" model="ir.actions.act_window">
                <field name="name">Clôtures comptables par projet</field>
                <field name="res_model">project.accounting_closing</field>
                <field name="view_mode">tree,form,pivot</field>
	</record>

	<menuitem name="Clôtures comptables" id="project_accounting_closing_menu_root" parent="project.menu_main_pm" />
	<menuitem name="Clôtures comptables" id="project_accounting_closing_menu_list" parent="project_accounting_closing_menu_root" action="project_accounting_closing_action"/>

   <record id="action_recompute_closing" model="ir.actions.server">
          <field name="name">recompute_closing</field>
          <field name="model_id" ref="model_project_accounting_closing"/>
          <field name="binding_model_id" ref="model_project_accounting_closing"/>
          <field name="state">code</field>
          <field name="code">for rec in records:
                  rec.compute()</field>
          <field name="groups_id" eval="[(4, ref('base.group_system'))]" />
  </record>
	</data>
</odoo>
